<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Gizi Pakan Unggas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        h1, h2 {
            text-align: center;
            color: #0056b3;
        }
        #calculator-form {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .unit-selection {
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .unit-selection label {
            margin: 0 15px;
            cursor: pointer;
        }
        .input-row {
            display: grid;
            grid-template-columns: 1fr 100px;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .input-row select, .input-row input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 12px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #218838;
        }
        #results {
            background: #e9ecef;
            padding: 20px;
            border-radius: 8px;
            display: none;
        }
        #results h2 {
            margin-top: 0;
            color: #17a2b8;
        }
        #nutrition-table {
            width: 100%; margin-top: 15px; border-collapse: collapse;
        }
        #nutrition-table th, #nutrition-table td {
            border: 1px solid #ccc; padding: 8px; text-align: left;
        }
        #nutrition-table th { background-color: #f2f2f2; }
        #nutrition-table td:nth-child(2) { text-align: right; font-weight: bold; }
        #recommendation {
            margin-top: 20px; padding: 15px; border: 1px solid #ddd;
            border-radius: 5px; background: #fff;
        }
        .footer {
            margin-top: 30px; text-align: center; font-style: italic; color: #6c757d;
        }
        .ig-logo {
            display: inline-block; width: 20px; height: 20px; border-radius: 6px;
            background: radial-gradient(circle at 30% 107%, #fdf497 0%, #fdf497 5%, #fd5949 45%,#d6249f 60%,#285AEB 90%);
            vertical-align: middle; margin-right: 5px;
        }
        .error { color: red; text-align: center; font-weight: bold; margin-bottom: 10px; }
        #loader { text-align: center; font-weight: bold; padding: 20px; }
    </style>
</head>
<body>

    <h1>Kalkulator Gizi Pakan Unggas</h1>

    <div id="loader">Memuat data bahan pakan...</div>

    <form id="calculator-form" style="display:none;">
        <div class="unit-selection">
            <label><input type="radio" name="unit" value="gram" checked> Gram</label>
            <label><input type="radio" name="unit" value="percent"> Persen (%)</label>
        </div>
        <div id="ingredient-inputs"></div>
        <p id="error-message" class="error" style="display:none;"></p>
        <button type="submit">Hitung Kandungan Gizi</button>
    </form>

    <div id="results">
        <h2>Hasil Analisis Pakan</h2>
        <p id="total-weight-display" style="text-align:center; font-weight:bold;"></p>
        <table id="nutrition-table">
            <thead><tr><th>Unsur Gizi</th><th>Hasil Campuran</th></tr></thead>
            <tbody></tbody>
        </table>
        <div id="recommendation"></div>
    </div>

    <footer class="footer">
        <p>"maju terus peternak Indonesia"</p>
        <p>by. <span class="ig-logo"></span> kandang.goen</p>
    </footer>

    <script>
        // Global variable to hold the feed data once loaded
        let feedData = {};

        // Function to parse nutrient values from text (e.g., "12-14", "Min 20", "N/A")
        function parseValue(text) {
            text = text.trim().toLowerCase();
            if (!text || text === 'n/a' || text === 'ada') {
                return 0;
            }
            if (text.startsWith('min')) {
                return parseFloat(text.replace('min', '').trim()) || 0;
            }
            if (text.startsWith('max')) {
                return parseFloat(text.replace('max', '').trim()) || 0;
            }
            if (text.includes('-')) {
                const parts = text.split('-').map(s => parseFloat(s.trim()));
                return (parts[0] + parts[1]) / 2;
            }
            return parseFloat(text) || 0;
        }

        // Function to fetch and parse the HTML data file
        async function loadFeedData() {
            try {
                const response = await fetch('unsur_pakan.html');
                if (!response.ok) {
                    throw new Error(`Gagal memuat file data: ${response.statusText}`);
                }
                const htmlText = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlText, 'text/html');
                const data = {};

                const rows = doc.querySelectorAll('table tbody tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length > 1) { // Ensure it's a data row
                        const name = cells[0].textContent.trim();
                        data[name] = {
                            protein: parseValue(cells[1].textContent),
                            energi: parseValue(cells[2].textContent),
                            lemak: parseValue(cells[3].textContent),
                            serat: parseValue(cells[4].textContent),
                            kalsium: parseValue(cells[5].textContent),
                            fosfor: parseValue(cells[6].textContent)
                        };
                    }
                });
                return data;
            } catch (error) {
                document.getElementById('loader').textContent = `Error: Tidak dapat memuat data dari unsur_pakan.html. Pastikan file berada di folder yang sama.`;
                console.error(error);
                return null;
            }
        }

        // Function to setup the application interface
        function setupApp(data) {
            feedData = data;
            const container = document.getElementById('ingredient-inputs');
            const ingredients = Object.keys(feedData);

            for (let i = 1; i <= 5; i++) {
                const row = document.createElement('div');
                row.className = 'input-row';
                const select = document.createElement('select');
                select.id = `ingredient-${i}`;
                let options = '<option value="">-- Pilih Bahan Pakan --</option>';
                ingredients.forEach(name => { options += `<option value="${name}">${name}</option>`; });
                select.innerHTML = options;
                
                const input = document.createElement('input');
                input.type = 'number';
                input.id = `amount-${i}`;
                input.placeholder = 'Jumlah';
                input.min = "0";
                
                row.appendChild(select);
                row.appendChild(input);
                container.appendChild(row);
            }

            // Hide loader and show form
            document.getElementById('loader').style.display = 'none';
            document.getElementById('calculator-form').style.display = 'block';
        }

        // Main logic starts when the window loads
        window.onload = async () => {
            const data = await loadFeedData();
            if (data) {
                setupApp(data);
            }
        };

        // --- Calculation and Display Logic (mostly unchanged) ---
        document.getElementById('calculator-form').addEventListener('submit', function(event) {
            event.preventDefault();
            // Calculation logic remains the same as previous version
            const unit = document.querySelector('input[name="unit"]:checked').value;
            const errorMessage = document.getElementById('error-message');
            errorMessage.style.display = 'none';

            let finalNutrients = { protein: 0, energi: 0, lemak: 0, serat: 0, kalsium: 0, fosfor: 0 };
            let totalWeight = 0;

            if (unit === 'gram') {
                for (let i = 1; i <= 5; i++) {
                    const ingredientName = document.getElementById(`ingredient-${i}`).value;
                    const amount = parseFloat(document.getElementById(`amount-${i}`).value);
                    if (ingredientName && amount > 0) {
                        const nutrientData = feedData[ingredientName];
                        totalWeight += amount;
                        for (const key in finalNutrients) {
                            finalNutrients[key] += amount * (nutrientData[key] || 0);
                        }
                    }
                }
                if (totalWeight > 0) {
                    for (const key in finalNutrients) {
                        finalNutrients[key] /= totalWeight;
                    }
                }
            } else { // unit is 'percent'
                let totalPercent = 0;
                for (let i = 1; i <= 5; i++) {
                    const ingredientName = document.getElementById(`ingredient-${i}`).value;
                    const amount = parseFloat(document.getElementById(`amount-${i}`).value);
                     if (ingredientName && amount > 0) {
                        const nutrientData = feedData[ingredientName];
                        totalPercent += amount;
                        for (const key in finalNutrients) {
                            finalNutrients[key] += amount / 100 * (nutrientData[key] || 0);
                        }
                    }
                }
                 if (Math.abs(totalPercent - 100) > 0.01 && totalPercent > 0) {
                     errorMessage.textContent = `Total persentase harus 100%, saat ini totalnya ${totalPercent.toFixed(2)}%.`;
                     errorMessage.style.display = 'block';
                     return;
                 }
            }
            
            displayResults(finalNutrients, totalWeight, unit);
        });

        function displayResults(nutrients, weight, unit) {
            const resultsDiv = document.getElementById('results');
            const tableBody = document.querySelector("#nutrition-table tbody");
            const recommendationEl = document.getElementById('recommendation');
            const totalWeightEl = document.getElementById('total-weight-display');

            tableBody.innerHTML = `
                <tr><td>Protein Kasar</td><td>${nutrients.protein.toFixed(2)} %</td></tr>
                <tr><td>Energi Metabolisme</td><td>${nutrients.energi.toFixed(0)} kkal/kg</td></tr>
                <tr><td>Lemak Kasar</td><td>${nutrients.lemak.toFixed(2)} %</td></tr>
                <tr><td>Serat Kasar</td><td>${nutrients.serat.toFixed(2)} %</td></tr>
                <tr><td>Kalsium</td><td>${nutrients.kalsium.toFixed(3)} %</td></tr>
                <tr><td>Fosfor</td><td>${nutrients.fosfor.toFixed(3)} %</td></tr>
            `;
            
            if (unit === 'gram' && weight > 0) {
                totalWeightEl.textContent = `Total Bobot Campuran: ${weight.toFixed(2)} Gram`;
            } else {
                totalWeightEl.textContent = '';
            }

            let recommendationHTML = '';
            const protein = nutrients.protein;
            if (protein >= 21) {
                recommendationHTML = `<h4>Sangat Cocok untuk Fase Awal (Starter)</h4><p>Kadar protein tinggi, ideal untuk mendukung pertumbuhan cepat pada masa awal kehidupan unggas.</p>`;
            } else if (protein >= 18) {
                recommendationHTML = `<h4>Sangat Cocok untuk Fase Pertumbuhan (Grower)</h4><p>Kadar protein sesuai untuk pembangunan massa otot dan perkembangan organ pada fase pertumbuhan.</p>`;
            } else if (protein >= 17) {
                 recommendationHTML = `<h4>Cukup untuk Fase Akhir (Finisher/Layer)</h4><p>Protein cukup untuk pemeliharaan dan produksi (daging/telur) pada unggas dewasa.</p>`;
            } else if (protein > 0) {
                 recommendationHTML = `<h4>Kurang Cocok (Protein di Bawah Standar Minimum 17%)</h4><p><b>Saran:</b> Untuk meningkatkan kadar protein, tambahkan bahan pakan sumber protein tinggi seperti <b>Bungkil Kedelai, Tepung Ikan,</b> atau <b>Konsentrat Protein</b> ke dalam campuran Anda.</p>`;
            } else {
                recommendationHTML = '<p>Silakan isi bahan pakan untuk melihat hasil dan rekomendasi.</p>';
            }
            recommendationEl.innerHTML = recommendationHTML;

            resultsDiv.style.display = 'block';
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>